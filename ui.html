<!DOCTYPE html>
<title>Magic: The Gathering Price Fetcher</title>
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?3.3.0/build/cssfonts/fonts-min.css&3.3.0/build/cssreset/reset-min.css&3.3.0/build/cssbase/base-min.css">
<link rel="stylesheet" type="text/css" href="./css/style.css">
<h1>Magic: The Gathering Price Fetcher</h1>

<form>
    <label>Set: <input id="setNameInput" type="text" /></label> 
    <label>Card: <input id="cardNameInput" type="text" /></label>
    <label>Count: <input id="countInput" type="text" size="4" value="1" /></label>
</form>

<script src="http://yui.yahooapis.com/3.4.0pr2/build/yui/yui-min.js"></script>
<script src="./lib/mtg_prices.js"></script>
<script>
YUI().use("mtg-prices", "autocomplete-plugin", "autocomplete-highlighters", "autocomplete-filters", function(Y){
    //localStorage.clear();
    var setNames = new Y.MTG.SetNames();
    //var cardSet = new Y.MTG.Set({id: "Revised Edition"});
    var cardSet;
    var setList = new Y.MTG.SetList();
//    setList.add(new Y.MTG.Set({id: "Revised Edition"}));
//    cardSet = setList.getById("Revised Edition");
    
    
    var setNameInput = Y.one("#setNameInput");
    var cardNameInput = Y.one("#cardNameInput");
    
    setNames.load(function(err, response){
        if (!err) {
            setNameInput.plug(Y.Plugin.AutoComplete, {
                resultHighlighter: "phraseMatch",
                resultFilters: "phraseMatch",
                source: setNames.get("data")
            });
        }
    });

    
    setNameInput.on("change", function(e) {
        var setName = e.target.get("value");
        var nameList = setNames.get("data");
        var set = null;
        
        if (Y.Array.indexOf(nameList, setName) === -1) {
            Y.log("OH NOES BAD SET NAME!!!");
            // set some error message
            // make sure other elements on the page respond appropriately
            return;
        }
    
        // Is the value of setNameInput in the ModelList? 
        //  - if so, set the cardNameInput AutoComplete source to that card set's data object
        //  - if not,
        //      - set a "loading data" message
        //      - create a new CardSet and add it to the ModelList
        //      - load the data remotely
        //      - eliminate the "loading data message"
        set = setList.getById(setName);
        if (! set) {
            // set a "loading data" message
            // this will be fast if the set is in localStorage, slow otherwise
            Y.log("loading; card set '" + setName + "' not found in set list.");
            set = new Y.MTG.Set({id: setName});
            set.load(function(err, response) {
                Y.log(set.get("data"));
            });
            setList.add(set);
            // eliminate the "loading data" message
        }
        else {
            Y.log("card set '" + setName + "' found in set list.");
            Y.log(set.get("data"));
        }
        /*
        cardNameInput.plug(Y.Plugin.AutoComplete, {
            resultHighlighter: "phraseMatch",
            resultFilters: "phraseMatch",
            source: Y.Object.keys(set.get("data"))
        });*/
    })
});
</script>